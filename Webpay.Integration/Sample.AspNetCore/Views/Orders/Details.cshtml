@using System.Reflection;
@model Sample.AspNetCore.Models.ViewModels.OrderListViewModel

@{
    ViewData["Title"] = "OrderDetails";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var count = 1;
}

@if (TempData["CancelMessage"] != null)
{
    <div class="alert alert-success">@TempData["CancelMessage"]</div>
}
else if (TempData["OrderRowMessage"] != null)
{
    <div class="alert alert-success">@TempData["OrderRowMessage"]</div>
}
else if (TempData["DeliverMessage"] != null)
{
    <div class="alert alert-success">@TempData["DeliverMessage"]</div>
}
else if (TempData["CreditMessage"] != null)
{
    <div class="alert alert-success">@TempData["CreditMessage"]</div>
}
else if (TempData["ReversalMessage"] != null)
{
    <div class="alert alert-success">@TempData["ReversalMessage"]</div>
}
else if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-warning">@TempData["ErrorMessage"]</div>
}

<h1>Details</h1>

<div>
    <hr />
    @foreach (var order in Model.PaymentOrders)
    {
        <div automation="div-fullorder">
            <div automation="div-order">
                <div>
                    <h2>Order #@count</h2>
                    <hr />
                    <h4>Order Details</h4>
                    <table class="table table-bordered">
                        <tbody>
                            <tr>
                                <th>Order ID</th>
                                <td>@order.Order.SveaOrderId</td>
                            </tr>
                            <tr>
                                <th>Billing Email</th>
                                <td>@order.Order.BillingEmailAddress</td>
                            </tr>
                            <tr>
                                <th>Changed Date</th>
                                <td>@(order.Order.ChangedDate?.ToString("yyyy-MM-dd HH:mm:ss") ?? "N/A")</td>
                            </tr>
                            <tr>
                                <th>Client ID</th>
                                <td>@order.Order.ClientId</td>
                            </tr>
                            <tr>
                                <th>Client Order ID</th>
                                <td>@order.Order.ClientOrderId</td>
                            </tr>
                            <tr>
                                <th>Created Date</th>
                                <td>@order.Order.CreatedDate.ToString("yyyy-MM-dd HH:mm:ss")</td>
                            </tr>
                            <tr>
                                <th>Credit Report Accepted</th>
                                <td>@(order.Order.CreditReportStatus?.Accepted.ToString() ?? "N/A")</td>
                            </tr>
                            <tr>
                                <th>Currency</th>
                                <td>@(order.Order.Currency ?? "N/A")</td>
                            </tr>
                            <tr>
                                <th>Customer Name</th>
                                <td>@(order.Order.Customer?.FullName ?? "N/A")</td>
                            </tr>
                            <tr>
                                <th>Customer ID</th>
                                <td>@(order.Order.CustomerId?.ToString() ?? "N/A")</td>
                            </tr>
                            <tr>
                                <th>Customer Reference</th>
                                <td>@(order.Order.CustomerReference ?? "N/A")</td>
                            </tr>
                            <tr>
                                <th>Delivery Address</th>
                                <td>@(order.Order.DeliveryAddress?.Street ?? "N/A")</td>
                            </tr>
                            <tr>
                                <th>Is Possible to Administer</th>
                                <td>@(order.Order.IsPossibleToAdminister ? "Yes" : "No")</td>
                            </tr>
                            <tr>
                                <th>Is Possible to Cancel</th>
                                <td>@(order.Order.IsPossibleToCancel ? "Yes" : "No")</td>
                            </tr>
                            <tr>
                                <th>Notes</th>
                                <td>@(order.Order.Notes ?? "N/A")</td>
                            </tr>
                            <tr>
                                <th>Order Delivery Status</th>
                                <td>@(order.Order.OrderDeliveryStatus ?? "N/A")</td>
                            </tr>
                            <tr>
                                <th>Order Status</th>
                                <td>@(order.Order.OrderStatus ?? "N/A")</td>
                            </tr>
                            <tr>
                                <th>Order Type</th>
                                <td>@(order.Order.OrderType ?? "N/A")</td>
                            </tr>
                            <tr>
                                <th>Svea Will Buy</th>
                                <td>@(order.Order.SveaWillBuy ? "Yes" : "No")</td>
                            </tr>
                        </tbody>
                    </table>

                    <h4>Order Rows</h4>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Row Number</th>
                                <th>Article Number</th>
                                <th>Description</th>
                                <th>Quantity</th>
                                <th>Price Per Unit</th>
                                <th>Discount Percent</th>
                                <th>Vat Percent</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var row in order.Order.OrderRows)
                            {
                                <tr>
                                    <td>@row.RowNumber</td>
                                    <td>@row.ArticleNumber</td>
                                    <td>@row.Description</td>
                                    <td>@Convert.ToInt32(row.NumberOfUnits)</td>
                                    <td>@row.PricePerUnit</td>
                                    <td>@row.DiscountPercent</td>
                                    <td>@row.VatPercent</td>
                                    <td>@row.Status</td>
                                </tr>
                            }
                        </tbody>
                    </table>

                    @if (order.Order.PendingReasons != null && order.Order.PendingReasons.Any())
                    {
                        <h4>Pending Reasons</h4>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Created Date</th>
                                    <th>Pending Type</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var reason in order.Order.PendingReasons)
                                {
                                    <tr>
                                        <td>@reason.CreatedDate.ToString("yyyy-MM-dd HH:mm:ss")</td>
                                        <td>@reason.PendingType</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }

                    @if (order.IsLoaded)
                    {
                        <h4>Order Actions</h4>
                        <table class="table" automation="table-order">
                            <thead class="collapsible" automation="toggle-actions">
                                <tr>
                                    <th>Actions</th>
                                    <th>
                                        <div automation="toggle-actions">Expand</div>
                                        <div automation="toggle-actions">Collapse</div>
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="collapsible-content">
                                <tr>
                                    <td colspan="2">
                                        <!-- Actions Dropdown -->
                                        <form method="post" asp-action="ExecuteAction" asp-controller="Orders">
                                            <input type="hidden" name="OrderId" value="@order.Order.SveaOrderId" />
                                            <div class="form-group">
                                                <label for="actionSelect">Select Action</label>
                                                <select id="actionSelect" name="Action" class="form-control" onchange="toggleRowEditing(this.value, @order.Order.SveaOrderId)">
                                                    <option value="">-- Select Action --</option>
                                                    @if (order.Order.OrderDeliveryStatus == "Created" || order.Order.OrderDeliveryStatus == "PartiallyDelivered")
                                                    {
                                                        <!-- WebpayService -->
                                                        <option value="CloseOrderEu">CloseOrderEu</option>
                                                        <option value="DeliverOrderEu">DeliverOrderEu</option>
                                                        @*<option value="GetAccountCreditParamsEu">GetAccountCreditParamsEu</option>
                                                        <option value="GetPaymentPlanParamsEu">GetPaymentPlanParamsEu</option>*@
                                                        <!-- AdminService -->
                                                        <option value="AddOrderRows">Add Order Rows</option>
                                                        <option value="UpdateOrderRows">Update Order Rows</option>
                                                        <option value="CancelOrderRows">Cancel Order Rows</option>
                                                        <option value="UpdateOrder">Update Order</option>
                                                        @if (order.Order.OrderType == "Invoice")
                                                        {
                                                            <option value="DeliverPartial">Deliver Partial</option>
                                                        }
                                                        <option value="DeliverOrders">Deliver Orders</option>
                                                        <option value="CancelOrder">Cancel Order</option>
                                                    }
                                                    @if ((order.Order.OrderDeliveryStatus == "Delivered" 
                                                        || order.Order.OrderDeliveryStatus == "PartiallyDelivered") 
                                                        && (order.Order.PendingReasons == null || !order.Order.PendingReasons.Any()))
                                                    {
                                                        <option value="CreditInvoiceRows">Credit Invoice Rows</option>
                                                        @if (order.Order.OrderType == "Invoice")
                                                        {
                                                            <option value="GetInvoices">Get Invoices</option>
                                                            <option value="ApproveInvoice">Approve Invoice</option>
                                                        }
                                                        <!-- WebpayService -->
                                                        @if (order.Order.OrderType == "PaymentPlan")
                                                        {
                                                            <option value="GetContractPdfEu">GetContractPdfEu</option>
                                                        }
                                                    }
                                                </select>
                                            </div>

                                            <!-- Editable Order Rows Section -->
                                            <div id="editOrderRows-@order.Order.SveaOrderId" class="edit-order-rows" style="display: none;">
                                                <h4>Edit Order Rows</h4>
                                                <table class="table table-bordered">
                                                    <thead>
                                                        <tr>
                                                            <th>Row Number</th>
                                                            <th>Article Number</th>
                                                            <th>Description</th>
                                                            <th>Quantity</th>
                                                            <th>Price Per Unit</th>
                                                            <th>Discount Percent</th>
                                                            <th>Vat Percent</th>
                                                        </tr>
                                                    </thead>
                                                    @*<tbody>*@
                                                    <tbody id="newOrderRows">
                                                        <!-- Existing Rows -->
                                                        @for (var i = 0; i < order.Order.OrderRows.Count(); i++)
                                                        {
                                                            var row = order.Order.OrderRows[i];
                                                            @if (row.Status == "NotDelivered")
                                                            {
                                                                <tr class="existing-order-row" style="display: none;">
                                                                    <td>
                                                                        @row.RowNumber
                                                                        <input type="hidden" name="OrderRows[@i].RowNumber" value="@row.RowNumber" />
                                                                    </td>
                                                                    <td><input type="text" name="OrderRows[@i].ArticleNumber" value="@row.ArticleNumber" /></td>
                                                                    <td><input type="text" name="OrderRows[@i].Description" value="@row.Description" /></td>
                                                                    <td><input type="number" name="OrderRows[@i].NumberOfUnits" value="@Convert.ToInt32(row.NumberOfUnits)" /></td>
                                                                    <td><input type="number" step="0.01" name="OrderRows[@i].PricePerUnit" value="@row.PricePerUnit" /></td>
                                                                    <td><input type="number" step="0.01" name="OrderRows[@i].DiscountPercent" value="@row.DiscountPercent" /></td>
                                                                    <td><input type="number" step="0.01" name="OrderRows[@i].VatPercent" value="@row.VatPercent" /></td>
                                                                </tr>
                                                            }
                                                        }

                                                        <!-- New Rows -->
                                                        <tr class="new-order-row" style="display: table-row;">
                                                            <td><span class="text-muted">New</span></td>
                                                            <td><input type="text" name="NewOrderRows[0].ArticleNumber" placeholder="New Article Number" /></td>
                                                            <td><input type="text" name="NewOrderRows[0].Description" placeholder="New Description" /></td>
                                                            @*<td><input type="number" name="NewOrderRows[0].Quantity" placeholder="New Quantity" /></td>*@
                                                            <td><input type="number" name="NewOrderRows[0].NumberOfUnits" placeholder="New Quantity" /></td>
                                                            <td><input type="number" step="0.01" name="NewOrderRows[0].PricePerUnit" placeholder="New Price Per Unit" /></td>
                                                            <td><input type="number" step="0.01" name="NewOrderRows[0].DiscountPercent" placeholder="New Discount Percent" /></td>
                                                            <td><input type="number" step="0.01" name="NewOrderRows[0].VatPercent" placeholder="New Vat Percent" /></td>
                                                        </tr>
                                                    </tbody>

                                                    <button type="button" class="btn btn-secondary" id="addNewRowButton" style="display: none;">Add New Row</button>
                                                </table>
                                            </div>

                                            <!-- Selectable Order Rows Section -->
                                            <div id="selectOrderRows-@order.Order.SveaOrderId" class="select-order-rows" style="display: none;">
                                                <h4>Select Order Rows</h4>
                                                <table class="table table-bordered">
                                                    <thead>
                                                        <tr>
                                                            <th>Row Number</th>
                                                            <th>Article Number</th>
                                                            <th>Description</th>
                                                            <th>Quantity</th>
                                                            <th>Price Per Unit</th>
                                                            <th>Discount Percent</th>
                                                            <th>Vat Percent</th>
                                                            <th>Select</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        @for (var i = 0; i < order.Order.OrderRows.Count(); i++)
                                                        {
                                                            var row = order.Order.OrderRows[i];
                                                            @if (row.Status != "Cancelled")
                                                            {
                                                                <tr class="@((row.Status == "Delivered") ? "delivered-row" : "not-delivered-row")" style="display: none;">
                                                                    <td>@row.RowNumber</td>
                                                                    <td>@row.ArticleNumber</td>
                                                                    <td>@row.Description</td>
                                                                    <td>@Convert.ToInt32(row.NumberOfUnits)</td>
                                                                    <td>@row.PricePerUnit</td>
                                                                    <td>@row.DiscountPercent</td>
                                                                    <td>@row.VatPercent</td>
                                                                    <td>
                                                                        <input type="checkbox" name="OrderRows[@i].IsSelected" value="true" />
                                                                        <input type="hidden" name="OrderRows[@i].RowNumber" value="@row.RowNumber" />
                                                                    </td>
                                                                </tr>
                                                            }
                                                        }
                                                    </tbody>
                                                </table>
                                            </div>
                                            <button type="submit" class="btn btn-primary">Execute Action</button>
                                        </form>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    }
                </div>
            </div>
        </div>
        count++;
    }
</div>

@section Scripts {
    <script>
        function toggleRowEditing(action, orderId) {
            const editSection = document.getElementById(`editOrderRows-${orderId}`);
            const existingRows = document.querySelectorAll(`#editOrderRows-${orderId} .existing-order-row`);
            const newRows = document.querySelectorAll(`#editOrderRows-${orderId} .new-order-row`);
            const addNewRowButton = document.getElementById("addNewRowButton");
			
            const selectRowsSection = document.getElementById(`selectOrderRows-${orderId}`);
			const deliveredRows = document.querySelectorAll(`#selectOrderRows-${orderId} .delivered-row`);
            const notDeliveredRows = document.querySelectorAll(`#selectOrderRows-${orderId} .not-delivered-row`);

            if (editSection) editSection.style.display = "none";
            if (selectRowsSection) selectRowsSection.style.display = "none";
            if (addNewRowButton) addNewRowButton.style.display = "none";

            if (action === "AddOrderRows" || action === "UpdateOrderRows") {
                editSection.style.display = "block";

                if (action === "UpdateOrderRows") {
                    existingRows.forEach(row => (row.style.display = "table-row"));
                    newRows.forEach(row => (row.style.display = "none"));
                } else if (action === "AddOrderRows") {
                    existingRows.forEach(row => (row.style.display = "none"));
                    newRows.forEach(row => (row.style.display = "table-row"));
                    addNewRowButton.style.display = "block";
                }
            } else if (action === "CancelOrderRows" || action === "DeliverPartial") {
                if (selectRowsSection) selectRowsSection.style.display = "block";

                notDeliveredRows.forEach(row => (row.style.display = "table-row"));
                deliveredRows.forEach(row => (row.style.display = "none"));

            } else if (action === "CreditInvoiceRows") {
                if (selectRowsSection) selectRowsSection.style.display = "block";
                notDeliveredRows.forEach(row => (row.style.display = "none"));
                deliveredRows.forEach(row => (row.style.display = "table-row"));
            } else {
                editSection.style.display = "none";
                existingRows.forEach(row => (row.style.display = "none"));
                newRows.forEach(row => (row.style.display = "none"));
            }
        }

        document.getElementById("addNewRowButton").addEventListener("click", function () {
            const tableBody = document.getElementById("newOrderRows");
            const rowCount = tableBody.children.length;
            const newRow = `
                <tr class="new-order-row">
                    <td><span class="text-muted">New</span></td>
                    <td><input type="text" name="NewOrderRows[${rowCount}].ArticleNumber" placeholder="New Article Number" /></td>
                    <td><input type="text" name="NewOrderRows[${rowCount}].Description" placeholder="New Description" /></td>
                    <td><input type="number" name="NewOrderRows[${rowCount}].NumberOfUnits" placeholder="New Quantity" /></td>
                    <td><input type="number" step="0.01" name="NewOrderRows[${rowCount}].PricePerUnit" placeholder="New Price Per Unit" /></td>
                    <td><input type="number" step="0.01" name="NewOrderRows[${rowCount}].DiscountPercent" placeholder="New Discount Percent" /></td>
                    <td><input type="number" step="0.01" name="NewOrderRows[${rowCount}].VatPercent" placeholder="New Vat Percent" /></td>
                    <td>
                        <button type="button" class="btn btn-danger remove-row-btn">Remove</button>
                    </td>
                </tr>`;
            tableBody.insertAdjacentHTML("beforeend", newRow);
        });

        // Delegate event listener for dynamically added remove buttons
        document.getElementById("newOrderRows").addEventListener("click", function (event) {
            if (event.target && event.target.classList.contains("remove-row-btn")) {
                const row = event.target.closest("tr");
                row.remove();
            }
        });
    </script>
}

