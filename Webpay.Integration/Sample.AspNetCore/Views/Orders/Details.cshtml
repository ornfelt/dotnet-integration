@using System.Reflection;
@model Sample.AspNetCore.Models.ViewModels.OrderListViewModel

@{
    ViewData["Title"] = "OrderDetails";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var count = 1;
}

@if (TempData["CancelMessage"] != null)
{
    <div class="alert alert-success">@TempData["CancelMessage"]</div>
}
else if (TempData["OrderRowMessage"] != null)
{
    <div class="alert alert-success">@TempData["OrderRowMessage"]</div>
}
else if (TempData["DeliverMessage"] != null)
{
    <div class="alert alert-success">@TempData["DeliverMessage"]</div>
}
else if (TempData["CreditMessage"] != null)
{
    <div class="alert alert-success">@TempData["CreditMessage"]</div>
}
else if (TempData["ReversalMessage"] != null)
{
    <div class="alert alert-success">@TempData["ReversalMessage"]</div>
}
else if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-warning">@TempData["ErrorMessage"]</div>
}

<h1>Details</h1>

<div>
    <hr />

    @foreach (var order in Model.PaymentOrders)
    {
        <div automation="div-fullorder">

            <div automation="div-order">
                <div>
                    <h2>Order #@count</h2>

                    <hr />

                    <h4>Order Details</h4>
                    <table class="table table-bordered">
                        <tbody>
                            <tr>
                                <th>Order ID</th>
                                <td>@order.Order.SveaOrderId</td>
                            </tr>
                            <tr>
                                <th>Billing Email</th>
                                <td>@order.Order.BillingEmailAddress</td>
                            </tr>
                            <tr>
                                <th>Changed Date</th>
                                <td>@(order.Order.ChangedDate?.ToString("yyyy-MM-dd HH:mm:ss") ?? "N/A")</td>
                            </tr>
                            <tr>
                                <th>Client ID</th>
                                <td>@order.Order.ClientId</td>
                            </tr>
                            <tr>
                                <th>Client Order ID</th>
                                <td>@order.Order.ClientOrderId</td>
                            </tr>
                            <tr>
                                <th>Created Date</th>
                                <td>@order.Order.CreatedDate.ToString("yyyy-MM-dd HH:mm:ss")</td>
                            </tr>
                            <tr>
                                <th>Credit Report Accepted</th>
                                <td>@(order.Order.CreditReportStatus?.Accepted.ToString() ?? "N/A")</td>
                            </tr>
                            <tr>
                                <th>Currency</th>
                                <td>@(order.Order.Currency ?? "N/A")</td>
                            </tr>
                            <tr>
                                <th>Customer Name</th>
                                <td>@(order.Order.Customer?.FullName ?? "N/A")</td>
                            </tr>
                            <tr>
                                <th>Customer ID</th>
                                <td>@(order.Order.CustomerId?.ToString() ?? "N/A")</td>
                            </tr>
                            <tr>
                                <th>Customer Reference</th>
                                <td>@(order.Order.CustomerReference ?? "N/A")</td>
                            </tr>
                            <tr>
                                <th>Delivery Address</th>
                                <td>@(order.Order.DeliveryAddress?.Street ?? "N/A")</td>
                            </tr>
                            <tr>
                                <th>Is Possible to Administer</th>
                                <td>@(order.Order.IsPossibleToAdminister ? "Yes" : "No")</td>
                            </tr>
                            <tr>
                                <th>Is Possible to Cancel</th>
                                <td>@(order.Order.IsPossibleToCancel ? "Yes" : "No")</td>
                            </tr>
                            <tr>
                                <th>Notes</th>
                                <td>@(order.Order.Notes ?? "N/A")</td>
                            </tr>
                            <tr>
                                <th>Order Delivery Status</th>
                                <td>@(order.Order.OrderDeliveryStatus ?? "N/A")</td>
                            </tr>
                            <tr>
                                <th>Order Status</th>
                                <td>@(order.Order.OrderStatus ?? "N/A")</td>
                            </tr>
                            <tr>
                                <th>Order Type</th>
                                <td>@(order.Order.OrderType ?? "N/A")</td>
                            </tr>
                            <tr>
                                <th>Svea Will Buy</th>
                                <td>@(order.Order.SveaWillBuy ? "Yes" : "No")</td>
                            </tr>
                        </tbody>
                    </table>

                    <h4>Order Rows</h4>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Row Number</th>
                                <th>Article Number</th>
                                <th>Description</th>
                                <th>Quantity</th>
                                <th>Price Per Unit</th>
                                <th>Discount Percent</th>
                                <th>Vat Percent</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var row in order.Order.OrderRows)
                            {
                                <tr>
                                    <td>@row.RowNumber</td>
                                    <td>@row.ArticleNumber</td>
                                    <td>@row.Description</td>
                                    <td>@Convert.ToInt32(row.NumberOfUnits)</td>
                                    <td>@row.PricePerUnit</td>
                                    <td>@row.DiscountPercent</td>
                                    <td>@row.VatPercent</td>
                                    <td>@row.Status</td>
                                </tr>
                            }
                        </tbody>
                    </table>

                    @if (order.Order.PendingReasons != null && order.Order.PendingReasons.Any())
                    {
                        <h4>Pending Reasons</h4>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Created Date</th>
                                    <th>Pending Type</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var reason in order.Order.PendingReasons)
                                {
                                    <tr>
                                        <td>@reason.CreatedDate.ToString("yyyy-MM-dd HH:mm:ss")</td>
                                        <td>@reason.PendingType</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }

                    @if (order.IsLoaded)
                    {
                        <h4>Order Actions</h4>
                        <table class="table" automation="table-order">
                            <thead class="collapsible" automation="toggle-actions">
                                <tr>
                                    <th>Actions</th>
                                    <th>
                                        <div automation="toggle-actions">Expand</div>
                                        <div automation="toggle-actions">Collapse</div>
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="collapsible-content">
                                <tr>
                                    <td colspan="2">
                                        <!-- Actions Dropdown -->
                                        <form method="post" asp-action="ExecuteAction" asp-controller="Orders">
                                            <input type="hidden" name="OrderId" value="@order.Order.SveaOrderId" />
                                            <div class="form-group">
                                                <label for="actionSelect">Select Action</label>
                                                <select id="actionSelect" name="Action" class="form-control">
                                                    @if (order.Order.OrderDeliveryStatus == "Created")
                                                    {
                                                        <!-- WebpayService -->
                                                        <option value="CloseOrderEu">CloseOrderEu</option>
                                                        <option value="DeliverOrderEu">DeliverOrderEu</option>
                                                        <option value="GetContractPdfEu">GetContractPdfEu</option>
                                                        <option value="GetAccountCreditParamsEu">GetAccountCreditParamsEu</option>
                                                        <option value="GetPaymentPlanParamsEu">GetPaymentPlanParamsEu</option>
                                                        <!-- AdminService -->
                                                        <option value="AddOrderRows">AddOrderRows</option>
                                                        <option value="UpdateOrderRows">Update Order Rows</option>
                                                        <option value="CancelOrderRows">Cancel Order Rows</option>
                                                        <option value="UpdateOrder">Update Order</option>
                                                        <option value="ApproveInvoice">Approve Invoice</option>
                                                        <option value="DeliverPartial">Deliver Partial</option>
                                                        <option value="DeliverOrders">Deliver Orders</option>
                                                        <option value="CancelOrder">Cancel Order</option>
                                                    }
                                                    @if (order.Order.OrderDeliveryStatus == "Delivered" && (order.Order.PendingReasons == null || !order.Order.PendingReasons.Any()))
                                                    {
                                                        <option value="CreditInvoiceRows">Credit Invoice Rows</option>
                                                        <option value="GetInvoices">Get Invoices</option>
                                                    }
                                                </select>
                                            </div>
                                            <button type="submit" class="btn btn-primary">Execute Action</button>
                                        </form>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    }
                </div>
            </div>
        </div>
        count++;
    }
</div>
